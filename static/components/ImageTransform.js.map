{
  "version": 3,
  "sources": ["/home/runner/work/imageCompare/imageCompare/src/components/ImageTransform.jsx"],
  "sourcesContent": ["/* ImageTransform.jsx */\n// canvas\u3092\u4F7F\u3063\u3066\u753B\u50CF\u306E\u4F4D\u7F6E\u5408\u308F\u305B\u3092\u3059\u308B\u306E\u3092\u3084\u3081\u308B\n// \u305D\u306E\u4EE3\u308F\u308A\u306Bleaflet\u306E\u30D4\u30F3\u3092\u7528\u3044\u3066\u4F4D\u7F6E\u306E\u7279\u5B9A\u3092\u884C\u306A\u3044\u3001\n// \u305D\u308C\u3092\u3082\u3068\u306Bopencv\u3067\u4F4D\u7F6E\u5408\u308F\u305B\u3092\u884C\u306A\u3046\n\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport Box from '@material-ui/core/Box';\n\n// \u81EA\u4F5C\u30E2\u30B8\u30E5\u30FC\u30EB\u306E\u8AAD\u307F\u8FBC\u307F\nimport PreviewImage from './PreviewImage';\n\nconst warpImage = (srcA, srcB, cPointsA, cPointsB, n_points) => {\n\t// srcA, srcB: \u5165\u529B\u753B\u50CF(cv.Mat)\n\t// cPointsA, cPointsB: \u5BFE\u5FDC\u70B9\u3002javascript\u306E\u914D\u5217\n\t// n_points: \u5BFE\u5FDC\u70B9\u306E\u500B\u6570\n\tconst matA = cv.matFromArray(n_points, 3, cv.CV_32F, cPointsA);\n\tconst matB = cv.matFromArray(n_points, 3, cv.CV_32F, cPointsB);\n\n\t// \u30DB\u30E2\u30B0\u30E9\u30D5\u30A3\u306E\u63A8\u5B9A\n\tconst estimateHomography = (matrixA, matrixB, method) => {\n\t\t// method: 0(default) or 4(LMEDS) or 8(RANSAC) or 16(RHO)\n\t\tlet homography = new cv.Mat(3, 3, cv.CV_32F);\n\t\thomography = cv.findHomography(matrixA, matrixB, method);\n\t\treturn homography;\n\t};\n\n\tlet H = estimateHomography(matA, matB, 0);\n\tlet dst = cv.Mat.zeros(srcB.rows, srcB.cols, cv.CV_8UC3);\n\n\tcv.warpPerspective(\n\t\tsrcA,\n\t\tdst,\n\t\tH,\n\t\tnew cv.Size(dst.cols, dst.rows),\n\t\tcv.INTER_LINEAR,\n\t\tcv.BORDER_CONSTANT,\n\t\tnew cv.Scalar()\n\t);\n\t//srcA.delete();\n\t//srcB.delete();\n\treturn dst;\n\t//dst.delete();\n};\n\nclass ImageTransform extends React.Component {\n\tconstructor(props) {\n\t\tsuper(props);\n\t\tthis.images = this.props.images;\n\t\tthis.state = {\n\t\t\tcorrespondingPointsArray: [null, null],\n\t\t};\n\t\tthis.setCorrespondingPoints = this.setCorrespondingPoints.bind(this);\n\t\tthis.invisibleCanvasRef = React.createRef();\n\t\tthis.n_marker = 4;\n\t}\n\n\tsetCorrespondingPoints(correspondingPoints, id) {\n\t\tlet array = this.state.correspondingPointsArray;\n\t\tarray[id] = correspondingPoints;\n\t\tthis.setState({\n\t\t\tcorrespondingPointsArray: array,\n\t\t});\n\t}\n\n\texecuteImageMatching() {\n\t\t// \u30DE\u30FC\u30AB\u30FC\u306E\u4F4D\u7F6E\u60C5\u5831\u304B\u3089\u5BFE\u5FDC\u70B9\u306E\u914D\u5217\u3092\u4F5C\u308B\n\t\tconst correspondingPoints_1 = this.state.correspondingPointsArray[0]\n\t\t\t.map((hash) => {\n\t\t\t\treturn [hash.x, hash.y, 1];\n\t\t\t})\n\t\t\t.flat();\n\t\tconst correspondingPoints_2 = this.state.correspondingPointsArray[1]\n\t\t\t.map((hash) => {\n\t\t\t\treturn [hash.x, hash.y, 1];\n\t\t\t})\n\t\t\t.flat();\n\t\t// \u753B\u50CF\u306E\u8AAD\u307F\u51FA\u3057\n\t\tconst createImgElement = (dataUrl) => {\n\t\t\tlet imgElement = new Image();\n\t\t\timgElement.src = dataUrl;\n\t\t\treturn imgElement;\n\t\t};\n\n\t\tlet image_1, image_2;\n\t\timage_1 = cv.imread(createImgElement(this.images[0].base64));\n\t\timage_2 = cv.imread(createImgElement(this.images[1].base64));\n\n\t\t// image_1\u3092image_2\u306E\u30B5\u30A4\u30BA\u3092\u3082\u3068\u306B\u5909\u63DB\u3059\u308B\n\t\tlet new_image_1 = warpImage(image_1, image_2, correspondingPoints_1, correspondingPoints_2, this.n_marker);\n\t\t// new_image_1\u3092\u4E00\u65E6canvas\u306B\u8CBC\u308A\u3001base64\u306B\u5909\u63DB\u3059\u308B\n\t\tcv.imshow(this.invisibleCanvasRef.current, new_image_1);\n\t\tlet dataUrl = this.invisibleCanvasRef.current.toDataURL('image/png', 1);\n\t\tconst imageObject = {\n\t\t\tname: this.images[0].name + '(Transformed)',\n\t\t\tbase64: dataUrl,\n\t\t\twidth: this.invisibleCanvasRef.current.width,\n\t\t\theight: this.invisibleCanvasRef.current.height,\n\t\t};\n\t\t// Workflow\u306B\u9001\u308B\n\t\tthis.props.onImageProcessingDone(imageObject);\n\t\t// \u4E0D\u8981\u306B\u306A\u3063\u305Fcv.Mat\u3092\u524A\u9664\u3057\u30E1\u30E2\u30EA\u3092\u89E3\u653E\n\t\timage_1.delete();\n\t\timage_2.delete();\n\t\tnew_image_1.delete();\n\t}\n\n\trender() {\n\t\treturn (\n\t\t\t<Box>\n\t\t\t\t<PreviewImage\n\t\t\t\t\timageId={0}\n\t\t\t\t\timage={this.images[0]}\n\t\t\t\t\tonPointsSet={this.setCorrespondingPoints}\n\t\t\t\t\tn_marker={this.n_marker}\n\t\t\t\t\tstyle={{width: \"50%\", float: \"left\"}}\n\t\t\t\t/>\n\t\t\t\t<PreviewImage\n\t\t\t\t\timageId={1}\n\t\t\t\t\timage={this.images[1]}\n\t\t\t\t\tonPointsSet={this.setCorrespondingPoints}\n\t\t\t\t\tn_marker={this.n_marker}\n\t\t\t\t\tstyle={{width: \"50%\"}}\n\t\t\t\t/>\n\t\t\t\t<canvas ref={this.invisibleCanvasRef} style={{ display: 'none' }}></canvas>\n\t\t\t</Box>\n\t\t);\n\t}\n}\n\nexport default ImageTransform;\n\nImageTransform.propTypes = {\n\timages: PropTypes.array.isRequired,\n\tonImageProcessingDone: PropTypes.func.isRequired,\n};\n"],
  "mappings": "AAKA;AACA;AACA;AAGA;AAEA,MAAM,YAAY,CAAC,MAAM,MAAM,UAAU,UAAU;AAIlD,QAAM,OAAO,GAAG,aAAa,UAAU,GAAG,GAAG,QAAQ;AACrD,QAAM,OAAO,GAAG,aAAa,UAAU,GAAG,GAAG,QAAQ;AAGrD,QAAM,qBAAqB,CAAC,SAAS,SAAS;AAE7C,QAAI,aAAa,IAAI,GAAG,IAAI,GAAG,GAAG,GAAG;AACrC,iBAAa,GAAG,eAAe,SAAS,SAAS;AACjD,WAAO;AAAA;AAGR,MAAI,IAAI,mBAAmB,MAAM,MAAM;AACvC,MAAI,MAAM,GAAG,IAAI,MAAM,KAAK,MAAM,KAAK,MAAM,GAAG;AAEhD,KAAG,gBACF,MACA,KACA,GACA,IAAI,GAAG,KAAK,IAAI,MAAM,IAAI,OAC1B,GAAG,cACH,GAAG,iBACH,IAAI,GAAG;AAIR,SAAO;AAAA;AAzCR,6BA6C6B,MAAM;AAAA,EAClC,YAAY;AACX,UAAM;AACN,SAAK,SAAS,KAAK,MAAM;AACzB,SAAK,QAAQ;AAAA,MACZ,0BAA0B,CAAC,MAAM;AAAA;AAElC,SAAK,yBAAyB,KAAK,uBAAuB,KAAK;AAC/D,SAAK,qBAAqB,MAAM;AAChC,SAAK,WAAW;AAAA;AAAA,EAGjB,uBAAuB,qBAAqB;AAC3C,QAAI,QAAQ,KAAK,MAAM;AACvB,UAAM,MAAM;AACZ,SAAK,SAAS;AAAA,MACb,0BAA0B;AAAA;AAAA;AAAA,EAI5B;AAEC,UAAM,wBAAwB,KAAK,MAAM,yBAAyB,GAChE,IAAI,CAAC;AACL,aAAO,CAAC,KAAK,GAAG,KAAK,GAAG;AAAA,OAExB;AACF,UAAM,wBAAwB,KAAK,MAAM,yBAAyB,GAChE,IAAI,CAAC;AACL,aAAO,CAAC,KAAK,GAAG,KAAK,GAAG;AAAA,OAExB;AAEF,UAAM,mBAAmB,CAAC;AACzB,UAAI,aAAa,IAAI;AACrB,iBAAW,MAAM;AACjB,aAAO;AAAA;AAGR,QAAI,SAAS;AACb,cAAU,GAAG,OAAO,iBAAiB,KAAK,OAAO,GAAG;AACpD,cAAU,GAAG,OAAO,iBAAiB,KAAK,OAAO,GAAG;AAGpD,QAAI,cAAc,UAAU,SAAS,SAAS,uBAAuB,uBAAuB,KAAK;AAEjG,OAAG,OAAO,KAAK,mBAAmB,SAAS;AAC3C,QAAI,UAAU,KAAK,mBAAmB,QAAQ,UAAU,aAAa;AACrE,UAAM,cAAc;AAAA,MACnB,MAAM,KAAK,OAAO,GAAG,OAAO;AAAA,MAC5B,QAAQ;AAAA,MACR,OAAO,KAAK,mBAAmB,QAAQ;AAAA,MACvC,QAAQ,KAAK,mBAAmB,QAAQ;AAAA;AAGzC,SAAK,MAAM,sBAAsB;AAEjC,YAAQ;AACR,YAAQ;AACR,gBAAY;AAAA;AAAA,EAGb;AACC,WACC,oCAAC,KAAD,MACC,oCAAC,cAAD;AAAA,MACC,SAAS;AAAA,MACT,OAAO,KAAK,OAAO;AAAA,MACnB,aAAa,KAAK;AAAA,MAClB,UAAU,KAAK;AAAA,MACf,OAAO,CAAC,OAAO,OAAO,OAAO;AAAA,QAE9B,oCAAC,cAAD;AAAA,MACC,SAAS;AAAA,MACT,OAAO,KAAK,OAAO;AAAA,MACnB,aAAa,KAAK;AAAA,MAClB,UAAU,KAAK;AAAA,MACf,OAAO,CAAC,OAAO;AAAA,QAEhB,oCAAC,UAAD;AAAA,MAAQ,KAAK,KAAK;AAAA,MAAoB,OAAO,CAAE,SAAS;AAAA;AAAA;AAAA;AAM5D,eAAe;AAEf,eAAe,YAAY;AAAA,EAC1B,QAAQ,UAAU,MAAM;AAAA,EACxB,uBAAuB,UAAU,KAAK;AAAA;",
  "names": []
}
